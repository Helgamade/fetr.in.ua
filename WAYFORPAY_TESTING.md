# Тестирование WayForPay

## Исправленные проблемы

1. **Формат суммы** - исправлено: теперь сумма передается в копейках (умножена на 100), как требует WayForPay
2. **Логирование** - добавлено подробное логирование для отладки
3. **Обработка ошибок** - добавлена обработка ошибок при создании платежа

## Как проверить исправления

### 1. Проверка переменных окружения

Убедитесь, что в `server/.env` на сервере есть:
```env
WAYFORPAY_MERCHANT_ACCOUNT=www_fetr_in_ua
WAYFORPAY_SECRET_KEY=77cbf18313c8c17e70ffe4bfad6b50fa37bb8ef5
WAYFORPAY_DOMAIN=fetr.in.ua
WAYFORPAY_RETURN_URL=https://fetr.in.ua/thank-you
WAYFORPAY_SERVICE_URL=https://fetr.in.ua/api/wayforpay/callback
```

### 2. Проверка логов

После попытки создать заказ с онлайн-оплатой, проверьте логи сервера:
```bash
# На сервере
cd /home/idesig02/fetr.in.ua/www
# Логи будут в консоли сервера или в stdout/stderr процесса Node.js
```

Ищите сообщения с префиксом `[WayForPay]`:
- `[WayForPay] Creating payment for order: ...`
- `[WayForPay] Order data: ...`
- `[WayForPay] Payment data created: ...`
- `[WayForPay] Callback received: ...`

### 3. Тестирование в браузере

1. Откройте консоль разработчика (F12)
2. Оформите заказ с онлайн-оплатой
3. Проверьте логи в консоли:
   - `[Checkout] Creating WayForPay payment for order: ...`
   - `[Checkout] Payment response received: ...`
   - `[Checkout] Submitting form to WayForPay`

### 4. Проверка редиректа

После создания заказа должна произойти автоматическая отправка формы на `https://secure.wayforpay.com/pay`.

Если редирект не происходит:
- Проверьте консоль браузера на ошибки
- Проверьте Network tab в DevTools - должен быть POST запрос на `/api/wayforpay/create-payment`
- Проверьте ответ сервера - должен содержать `paymentUrl` и `paymentData`

### 5. Проверка формата данных

В логах сервера проверьте, что:
- `amount` и `productPrice` указаны в копейках (например, для 100 грн должно быть 10000)
- Все обязательные поля присутствуют
- `merchantSignature` сгенерирован

### 6. Тестовые карты WayForPay

Для тестирования используйте тестовые карты из документации WayForPay:
- [Тестовые реквизиты](https://wiki.wayforpay.com/uk/view/852100)

## Возможные проблемы

### Заказ проходит без оплаты

**Причина:** Неправильный формат данных или отсутствие редиректа на WayForPay

**Решение:**
1. Проверьте логи сервера - должны быть сообщения о создании платежа
2. Проверьте консоль браузера - должна быть отправка формы на WayForPay
3. Проверьте, что сумма в копейках (умножена на 100)

### Ошибка "Invalid signature"

**Причина:** Неправильная подпись из-за неправильного формата данных

**Решение:**
1. Проверьте, что `WAYFORPAY_SECRET_KEY` правильный
2. Проверьте, что все поля передаются в правильном формате
3. Проверьте логи - там будет видно, какие данные отправляются

### Форма не отправляется

**Причина:** Ошибка при создании платежа или неправильный ответ от сервера

**Решение:**
1. Проверьте консоль браузера на ошибки
2. Проверьте Network tab - должен быть успешный ответ от `/api/wayforpay/create-payment`
3. Проверьте, что `paymentResponse.paymentUrl` и `paymentResponse.paymentData` присутствуют

## Контакты для поддержки

Если проблема не решена:
- Техническая поддержка WayForPay: tech@wayforpay.com
- Документация: https://wiki.wayforpay.com/uk

