# Настройка интеграции с Новой Почтой

## Шаг 1: Получение API ключа

1. Зарегистрируйтесь в личном кабинете Новой Почты
2. Перейдите в раздел настроек API:
   - https://my.novaposhta.ua/auth#apikeys
   - или https://new.novaposhta.ua/dashboard/settings/developers
3. Создайте новый API ключ
4. Добавьте ключ в файл `.env` в папке `server/`:
   ```
   NOVA_POSHTA_API_KEY=ваш_ключ_здесь
   ```
   
   **Важно:** Файл `.env` должен находиться в `server/.env`, а не в корне проекта!

## Шаг 2: Создание таблиц в базе данных

Выполните SQL скрипт для создания таблиц справочников:

```bash
mysql -u ваш_пользователь -p ваша_база < database/create_nova_poshta_tables.sql
```

Или выполните SQL вручную через phpMyAdmin или другой клиент MySQL.

## Шаг 3: Добавление полей в таблицу orders

Выполните SQL скрипт для добавления полей ref:

```bash
mysql -u ваш_пользователь -p ваша_база < database/add_nova_poshta_refs_to_orders.sql
```

## Шаг 4: Загрузка справочников

Запустите скрипт для загрузки данных из API Новой Почты:

```bash
node server/scripts/load-nova-poshta-data.js
```

Этот скрипт:
- Загрузит все города Украины
- Загрузит все отделения и почтоматы для каждого города
- Отметит популярные города (Киев, Одесса, Днепр, Харьков, Львов и др.)
- Отсортирует отделения по номеру

**Внимание:** Загрузка может занять несколько минут, так как для каждого города делается отдельный запрос к API.

## Шаг 5: Периодическое обновление справочников

Рекомендуется обновлять справочники раз в месяц или при необходимости. Для этого просто запустите скрипт загрузки снова:

```bash
node server/scripts/load-nova-poshta-data.js
```

Можно настроить автоматическое обновление через cron:

```bash
# Обновление раз в месяц (1-го числа в 3:00 ночи)
0 3 1 * * cd /path/to/project && node server/scripts/load-nova-poshta-data.js
```

## Использование в форме заказа

После выполнения всех шагов форма оформления заказа автоматически будет использовать справочники Новой Почты:

1. При выборе "Нова Пошта" появляются радиокнопки:
   - У відділення (по умолчанию)
   - У поштомат

2. При клике на поле "Населений пункт":
   - Появляется поле поиска
   - Показываются популярные города
   - При вводе от 3 букв начинается поиск

3. После выбора города активируется поле "Відділення":
   - Появляется поле поиска
   - Список отделений отсортирован по номеру (от меньшего к большему)
   - Можно искать по номеру или адресу

4. После выбора отделения поля закрываются и показываются выбранные значения

## API Endpoints

После настройки доступны следующие endpoints:

- `GET /api/nova-poshta/cities/popular` - популярные города
- `GET /api/nova-poshta/cities/search?q=текст` - поиск городов
- `GET /api/nova-poshta/cities/:ref` - информация о городе
- `GET /api/nova-poshta/warehouses?cityRef=xxx&type=PostOffice&search=текст` - отделения города
- `GET /api/nova-poshta/warehouses/:ref` - информация об отделении

## Структура данных

### Таблица nova_poshta_cities
- `ref` - уникальный идентификатор города (UUID)
- `description_ua` - название на украинском
- `description_ru` - название на русском
- `area_description_ua` - область на украинском
- `is_popular` - флаг популярного города
- `sort_order` - порядок сортировки для популярных

### Таблица nova_poshta_warehouses
- `ref` - уникальный идентификатор отделения (UUID)
- `site_key` - номер отделения
- `description_ua` - описание на украинском
- `city_ref` - ссылка на город
- `type_of_warehouse` - тип: PostOffice или Postomat
- `number` - номер для сортировки
- `phone` - телефон отделения

## Устранение проблем

### Ошибка "NOVA_POSHTA_API_KEY не установлен"
Убедитесь, что в файле `.env` на сервере указан ключ API.

### Ошибка при загрузке данных
- Проверьте подключение к интернету
- Убедитесь, что API ключ действителен
- Проверьте лимиты API (Новая Почта может ограничивать количество запросов)

### Отделения не загружаются для некоторых городов
Это нормально - некоторые города могут не иметь отделений. Скрипт продолжит работу с другими городами.

