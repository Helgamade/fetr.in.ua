<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  
  # Proxy API requests to Node.js server
  # Note: If proxying is configured via hosting panel, this rule may not be needed
  # Use internal IP and port provided by hosting (127.1.5.169:3000)
  RewriteCond %{REQUEST_URI} ^/api/
  RewriteRule ^api/(.*)$ http://127.1.5.169:3000/api/$1 [P,L]

  # Proxy sitemap.xml to Node.js (dynamic generation from DB)
  RewriteRule ^sitemap\.xml$ http://127.1.5.169:3000/sitemap.xml [P,L]
  
  # Don't rewrite files or directories that exist
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  
  # Don't rewrite assets, images, or other static files
  RewriteCond %{REQUEST_URI} !^/assets/
  RewriteCond %{REQUEST_URI} !\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ [NC]
  
  # Rewrite everything else to index.html
  RewriteRule . /index.html [L]
</IfModule>

# Enable compression
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# MIME types for JavaScript modules (КРИТИЧНО для module scripts!)
# ВАЖНО: Без правильных MIME типов браузер не загрузит module scripts!
<IfModule mod_mime.c>
  # Основной MIME тип для JavaScript модулей
  AddType application/javascript .js
  AddType application/javascript .mjs
  
  # Альтернативный MIME тип (для совместимости)
  AddType text/javascript .js
  
  # Явно указываем MIME тип для всех JS файлов в assets/
  <FilesMatch "\.js$">
    ForceType application/javascript
  </FilesMatch>
  
  # Для .mjs файлов
  <FilesMatch "\.mjs$">
    ForceType application/javascript
  </FilesMatch>
</IfModule>

# Дополнительная настройка для правильной обработки module scripts
<IfModule mod_headers.c>
  # Устанавливаем правильный Content-Type для JS файлов
  <FilesMatch "\.(js|mjs)$">
    Header set Content-Type "application/javascript; charset=utf-8"
  </FilesMatch>
</IfModule>

# Cache static assets
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/avif "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType application/pdf "access plus 1 month"
</IfModule>

# Cache-Control headers
<IfModule mod_headers.c>
  # Хешированные ассеты (/assets/*.js, /assets/*.css) — immutable, 1 год
  <FilesMatch "\.(js|css)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Шрифты — долгий кеш
  <FilesMatch "\.(woff2|woff|ttf|eot)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>

  # Изображения в /uploads/ — 1 год (при обновлении меняется имя файла)
  <FilesMatch "\.(jpg|jpeg|png|gif|webp|avif|svg)$">
    Header set Cache-Control "public, max-age=31536000"
  </FilesMatch>

  # index.html — не кешировать (всегда свежий)
  <FilesMatch "^index\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
  </FilesMatch>
</IfModule>

