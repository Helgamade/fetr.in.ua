# Реализация API Укрпошты - Итоговая информация

## Обзор

Реализована интеграция API Укрпошты для выбора города и отделения согласно официальной документации.

## Используемые API

### 1. Адресный классификатор (для поиска городов и отделений)

- **URL:** `https://ukrposhta.ua/address-classifier-ws/`
- **Токен:** Не требуется (публичный API)
- **Документация:** 
  - `Search-offices-and-indexes-v3.pdf` - рекомендации по поиску
  - `Address-classifier-v3.20-09122024.pdf` - полная документация классификатора

### 2. ecom API (для создания отправлений - не используется в текущей реализации)

- **URL:** `https://www.ukrposhta.ua/ecom/0.0.1`
- **Токен:** Требуется Bearer токен (из `АРІ_ключі.pdf`)
- **Документация:** `API-інструкція.pdf` (раздел 2 "Адреса")

## Реализованные endpoints

### Backend (`server/routes/ukrposhta.js`)

1. **GET `/api/ukrposhta/cities/popular`**
   - Возвращает список популярных городов
   - Не требует API вызова

2. **GET `/api/ukrposhta/cities/search?q={query}`**
   - Поиск городов по названию
   - Использует адресный классификатор: `/get_city_by_region_id_and_city_ua?region_id=...&city_ua=...`
   - Ищет в популярных областях параллельно
   - Возвращает города с `CITY_ID` для получения отделений

3. **GET `/api/ukrposhta/cities/:id`**
   - Получение информации о городе по ID
   - Использует адресный классификатор (если endpoint доступен)

4. **GET `/api/ukrposhta/branches?cityId={CITY_ID}&search={query}`**
   - Получение отделений для города
   - Использует адресный классификатор: `/get_postoffices_by_city_id?city_id={CITY_ID}`
   - **Важно:** Требует `cityId` (CITY_ID), а не postalCode

5. **GET `/api/ukrposhta/branches/:id`**
   - Получение информации об отделении по ID
   - Использует адресный классификатор

## Структура данных

### Город (UkrposhtaCity)
```typescript
{
  id: string;        // CITY_ID из адресного классификатора
  name: string;      // CITY_UA (название на украинском)
  postalCode: string; // POSTCODE (может быть пустым)
  region?: string;   // REGION_UA
  district?: string; // DISTRICT_UA
  cityId?: string;  // CITY_ID (для получения отделений)
}
```

### Отделение (UkrposhtaBranch)
```typescript
{
  id: string;        // POSTOFFICE_ID
  name: string;      // POSTOFFICE_UA
  address: string;   // ADDRESS_UA
  postalCode: string; // POSTCODE
  cityId?: string;   // CITY_ID
}
```

## Процесс работы

1. **Поиск города:**
   - Пользователь вводит название города
   - Система ищет в популярных областях через адресный классификатор
   - Возвращает список городов с `CITY_ID`

2. **Выбор города:**
   - Пользователь выбирает город
   - Сохраняется `CITY_ID` города

3. **Получение отделений:**
   - По `CITY_ID` запрашиваются отделения через `/get_postoffices_by_city_id?city_id={CITY_ID}`
   - Отображается список отделений

4. **Выбор отделения:**
   - Пользователь выбирает отделение
   - Сохраняется `POSTOFFICE_ID` и `POSTCODE`

## Настройка

### Текущая реализация (не требует настройки)

Адресный классификатор - публичный API, токен не требуется. Работает сразу.

### Для будущего использования ecom API

Если в будущем понадобится создавать отправления через ecom API, добавьте в `server/.env`:

```env
UKRPOSHTA_API_BASE=https://www.ukrposhta.ua/ecom/0.0.1
UKRPOSHTA_BEARER_TOKEN=ваш_bearer_токен_из_АРІ_ключі.pdf
```

## Документация

- **Поиск городов и отделений:** `Search-offices-and-indexes-v3.pdf`
- **Адресный классификатор:** `Address-classifier-v3.20-09122024.pdf`
- **ecom API:** `API-інструкція.pdf`
- **API ключи:** `АРІ_ключі.pdf`

## Важные замечания

1. **CITY_ID обязателен:** Для получения отделений обязательно нужен `CITY_ID` из адресного классификатора, а не только `postalCode`.

2. **Поиск городов:** Текущая реализация ищет в популярных областях. Для полного поиска по всем областям нужно сначала получить список всех областей через `/get_regions_by_region_ua?region_name=` (без параметра для получения всех).

3. **Формат ответа:** Адресный классификатор возвращает данные в формате:
   ```json
   {
     "Entries": {
       "Entry": [...]
     }
   }
   ```

4. **Одинаковые названия:** В одном районе может быть несколько населенных пунктов с одинаковым названием. Каждый имеет свой `CITY_ID`. Необходимо учитывать `DISTRICT_ID` и `REGION_ID`.

## Тестирование

После развертывания проверьте работу API:

```bash
# Популярные города
curl https://fetr.in.ua/api/ukrposhta/cities/popular

# Поиск городов
curl "https://fetr.in.ua/api/ukrposhta/cities/search?q=Київ"

# Получение отделений (нужен CITY_ID)
curl "https://fetr.in.ua/api/ukrposhta/branches?cityId=10952"
```

## Следующие шаги

1. Протестировать работу с реальным адресным классификатором API
2. При необходимости обновить список популярных областей для поиска
3. При необходимости реализовать получение всех областей для полного поиска
4. Если понадобится создание отправлений, интегрировать ecom API с Bearer токеном

