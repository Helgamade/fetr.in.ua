import{j as e}from"./chunk-lottie-CUWK48HK.js";import{r}from"./chunk-charts-BaLkbnPn.js";import{b as u,B as D,h as ee,v as se,w as ae,f as S,i as P,as as h}from"./index-Mb4dqRW5.js";import{C as v,a as N,b,c as w,d as T}from"./card-BW_lIITm.js";import{B as y}from"./button-CL77314Q.js";import{I as C}from"./input-BBBsi8Z9.js";import{L as _}from"./label-DA-KCtde.js";import{S as ie}from"./switch-Cd6CofSG.js";import{T as te}from"./textarea-ozEdaEw_.js";import{T as ne,a as re,b as E,c as F}from"./tabs-DRcAQrGA.js";import{B as oe}from"./badge-Cl6R0bRP.js";import{S as ce,C as le}from"./settings-DWjveQaJ.js";import{F as de}from"./file-text-DKC1e1et.js";import{S as J}from"./save-7Io4OaC_.js";import{P as me,T as xe}from"./trash-2-DUN5CE86.js";import{C as he}from"./chevron-left-DQaHxdrf.js";import{C as ue}from"./chevron-right-HukR2P5q.js";import"./index-ZeZSZmiz.js";import"./index-D4-djExh.js";const A=r.forwardRef(({className:a,...i},t)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:t,className:u("w-full caption-bottom text-sm",a),...i})}));A.displayName="Table";const V=r.forwardRef(({className:a,...i},t)=>e.jsx("thead",{ref:t,className:u("[&_tr]:border-b",a),...i}));V.displayName="TableHeader";const G=r.forwardRef(({className:a,...i},t)=>e.jsx("tbody",{ref:t,className:u("[&_tr:last-child]:border-0",a),...i}));G.displayName="TableBody";const fe=r.forwardRef(({className:a,...i},t)=>e.jsx("tfoot",{ref:t,className:u("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",a),...i}));fe.displayName="TableFooter";const I=r.forwardRef(({className:a,...i},t)=>e.jsx("tr",{ref:t,className:u("border-b transition-colors data-[state=selected]:bg-muted hover:bg-muted/50",a),...i}));I.displayName="TableRow";const d=r.forwardRef(({className:a,...i},t)=>e.jsx("th",{ref:t,className:u("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",a),...i}));d.displayName="TableHead";const m=r.forwardRef(({className:a,...i},t)=>e.jsx("td",{ref:t,className:u("p-4 align-middle [&:has([role=checkbox])]:pr-0",a),...i}));m.displayName="TableCell";const pe=r.forwardRef(({className:a,...i},t)=>e.jsx("caption",{ref:t,className:u("mt-4 text-sm text-muted-foreground",a),...i}));pe.displayName="TableCaption";function Ie(){var M,U,z;const{toast:a}=D(),i=ee(),t=se(),q=ae(),W=t.pathname.split("/").pop()||"settings";r.useEffect(()=>{t.pathname==="/admin/social-proof"&&q("/admin/social-proof/settings",{replace:!0})},[t.pathname,q]);const{data:x={},isLoading:je}=S({queryKey:["social-proof-settings"],queryFn:()=>h("/social-proof/settings")}),{data:L=[]}=S({queryKey:["social-proof-types"],queryFn:()=>h("/social-proof/notification-types")}),{data:X=[]}=S({queryKey:["social-proof-names"],queryFn:()=>h("/social-proof/names")}),[B,k]=r.useState([]);r.useEffect(()=>{L.length>0&&k(L)},[L]);const[g,Q]=r.useState(1),{data:n,isLoading:Y}=S({queryKey:["social-proof-logs",g],queryFn:()=>h(`/social-proof/logs?page=${g}&limit=50`),retry:1}),[c,p]=r.useState({first_notification_delay:60,notification_interval:60,notification_order:"random",max_notifications_per_session:10,city_search_radius:30});r.useEffect(()=>{x&&Object.keys(x).length>0&&p({first_notification_delay:x.first_notification_delay||60,notification_interval:x.notification_interval||60,notification_order:x.notification_order||"random",max_notifications_per_session:x.max_notifications_per_session||10,city_search_radius:x.city_search_radius||30})},[x]);const R=P({mutationFn:async s=>{try{return await h("/social-proof/settings",{method:"PUT",body:JSON.stringify(s)})}catch(o){throw console.error("Error saving settings:",o),o}},onSuccess:()=>{a({title:"Налаштування збережено"}),i.invalidateQueries({queryKey:["social-proof-settings"]})},onError:s=>{const o=(s==null?void 0:s.message)||"Помилка збереження";a({title:"Помилка збереження",description:o,variant:"destructive"}),console.error("Error saving settings:",s)}}),K=P({mutationFn:async s=>{const o=s.map(l=>h(`/social-proof/notification-types/${l.id}`,{method:"PUT",body:JSON.stringify({name:l.name,template:l.template,is_enabled:l.is_enabled,sort_order:l.sort_order})}));await Promise.all(o)},onSuccess:()=>{a({title:"Типи збережено"}),i.invalidateQueries({queryKey:["social-proof-types"]})},onError:s=>{const o=(s==null?void 0:s.message)||"Помилка збереження";a({title:"Помилка збереження типів",description:o,variant:"destructive"}),console.error("Error saving notification types:",s)}}),[j,H]=r.useState(""),$=P({mutationFn:s=>h("/social-proof/names",{method:"POST",body:JSON.stringify({name:s})}),onSuccess:()=>{a({title:"Ім'я додано"}),H(""),i.invalidateQueries({queryKey:["social-proof-names"]})},onError:()=>{a({title:"Помилка додавання",variant:"destructive"})}}),O=P({mutationFn:s=>h(`/social-proof/names/${s}`,{method:"DELETE"}),onSuccess:()=>{a({title:"Ім'я видалено"}),i.invalidateQueries({queryKey:["social-proof-names"]})},onError:()=>{a({title:"Помилка видалення",variant:"destructive"})}}),Z=s=>(typeof s=="string"?new Date(s):s).toLocaleString("uk-UA",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Соціальні підтвердження"}),e.jsx("p",{className:"text-muted-foreground",children:"Налаштування автоматичних сповіщень"})]}),e.jsxs(ne,{value:W,onValueChange:s=>q(`/admin/social-proof/${s}`),className:"space-y-4",children:[e.jsxs(re,{children:[e.jsxs(E,{value:"settings",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Налаштування"]}),e.jsxs(E,{value:"types",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Типи сповіщень"]}),e.jsx(E,{value:"names",children:"Імена"}),e.jsxs(E,{value:"logs",children:[e.jsx(le,{className:"w-4 h-4 mr-2"}),"Логи (",((M=n==null?void 0:n.pagination)==null?void 0:M.total)||0,")"]})]}),e.jsx(F,{value:"settings",children:e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(b,{children:"Основні налаштування"}),e.jsx(w,{children:"Налаштування інтервалів та порядку показу сповіщень"})]}),e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Затримка першого сповіщення (секунд)"}),e.jsx(C,{type:"number",min:"0",value:c.first_notification_delay,onChange:s=>p({...c,first_notification_delay:parseInt(s.target.value)||0})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Перше сповіщення з'явиться через вказану кількість секунд після заходу на сайт"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Інтервал між сповіщеннями (секунд)"}),e.jsx(C,{type:"number",min:"1",value:c.notification_interval,onChange:s=>p({...c,notification_interval:parseInt(s.target.value)||60})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Мінімальний інтервал між показом сповіщень"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Максимальна кількість сповіщень за сесію"}),e.jsx(C,{type:"number",min:"1",value:c.max_notifications_per_session,onChange:s=>p({...c,max_notifications_per_session:parseInt(s.target.value)||10})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Порядок показу"}),e.jsxs("select",{className:"w-full p-2 border rounded-md",value:c.notification_order,onChange:s=>p({...c,notification_order:s.target.value}),children:[e.jsx("option",{value:"sequential",children:"Послідовний (по черзі)"}),e.jsx("option",{value:"random",children:"Випадковий"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Радіус пошуку міста (км)"}),e.jsx(C,{type:"number",min:"1",max:"100",value:c.city_search_radius,onChange:s=>p({...c,city_search_radius:parseInt(s.target.value)||30})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:'Радіус пошуку міст для уведомлень типу "Ольга (Київ) купила N годин тому". Випадковий місто буде вибране з цього радіусу'})]}),e.jsxs(y,{onClick:()=>R.mutate(c),disabled:R.isPending,children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),R.isPending?"Збереження...":"Зберегти налаштування"]})]})]})}),e.jsx(F,{value:"types",children:e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(b,{children:"Типи сповіщень"}),e.jsx(w,{children:"Налаштування шаблонів та порядку показу сповіщень"})]}),e.jsxs(T,{children:[e.jsx("div",{className:"space-y-4",children:B.map(s=>e.jsxs(v,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(b,{children:s.name}),e.jsxs(w,{children:["Код: ",s.code]})]}),e.jsx(ie,{checked:s.is_enabled,onCheckedChange:o=>{k(l=>l.map(f=>f.id===s.id?{...f,is_enabled:o}:f))}})]})}),e.jsx(T,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Шаблон повідомлення"}),e.jsx(te,{value:s.template,onChange:o=>{k(l=>l.map(f=>f.id===s.id?{...f,template:o.target.value}:f))},rows:3,className:"font-mono text-sm"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Змінні: ",s.code==="viewing"||s.code==="purchased_today"?"{count}, {product_name}":"{name}, {city}, {hours_ago}, {product_name}"]})]})})]},s.id))}),e.jsx("div",{className:"mt-6 pt-6 border-t",children:e.jsxs(y,{onClick:()=>K.mutate(B),disabled:K.isPending,children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),K.isPending?"Збереження...":"Зберегти типи сповіщень"]})})]})]})}),e.jsx(F,{value:"names",children:e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(b,{children:"Список імен"}),e.jsx(w,{children:'Імена для персональних сповіщень типу "Ольга (Київ) купила..."'})]}),e.jsxs(T,{children:[e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx(C,{placeholder:"Нове ім'я (наприклад, Ольга)",value:j,onChange:s=>H(s.target.value),onKeyPress:s=>{s.key==="Enter"&&j.trim()&&$.mutate(j.trim())}}),e.jsxs(y,{onClick:()=>{j.trim()&&$.mutate(j.trim())},disabled:$.isPending||!j.trim(),children:[e.jsx(me,{className:"w-4 h-4 mr-2"}),"Додати"]})]}),e.jsx("div",{className:"space-y-2",children:X.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50",children:[e.jsx("span",{className:"font-medium",children:s.name}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>O.mutate(s.id),disabled:O.isPending,children:e.jsx(xe,{className:"w-4 h-4 text-destructive"})})]},s.id))})]})]})}),e.jsx(F,{value:"logs",children:e.jsxs(v,{children:[e.jsxs(N,{children:[e.jsx(b,{children:"Логи відправки сповіщень"}),e.jsx(w,{children:"Всі відправлені сповіщення користувачам"})]}),e.jsx(T,{children:Y?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Завантаження логів..."}):((U=n==null?void 0:n.logs)==null?void 0:U.length)===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Логів поки що немає"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(A,{children:[e.jsx(V,{children:e.jsxs(I,{children:[e.jsx(d,{children:"Час"}),e.jsx(d,{children:"Користувач/Сесія"}),e.jsx(d,{children:"Тип"}),e.jsx(d,{children:"Товар"}),e.jsx(d,{children:"Повідомлення"}),e.jsx(d,{children:"Місто (IP)"}),e.jsx(d,{children:"Місто (НП)"}),e.jsx(d,{children:"Координати"})]})}),e.jsx(G,{children:(z=n==null?void 0:n.logs)==null?void 0:z.map(s=>e.jsxs(I,{children:[e.jsx(m,{className:"whitespace-nowrap",children:Z(s.created_at)}),e.jsx(m,{className:"text-xs font-mono",children:s.analytics_user_id?`User ${s.analytics_user_id} (Session ${s.analytics_session_id_value||s.analytics_session_id})`:`Session ${s.analytics_session_id_value||s.analytics_session_id||s.session_id}`}),e.jsx(m,{children:e.jsx(oe,{variant:s.notification_type==="viewing"?"default":s.notification_type==="purchased_today"?"secondary":"outline",children:s.notification_type})}),e.jsx(m,{className:"max-w-xs truncate",children:s.product_name||"-"}),e.jsx(m,{className:"max-w-md",children:e.jsx("div",{className:"truncate",title:s.message_text,children:s.message_text})}),e.jsx(m,{children:s.client_city_from_ip||"-"}),e.jsx(m,{children:s.client_city_from_np||"-"}),e.jsx(m,{className:"text-xs font-mono",children:s.client_latitude&&s.client_longitude?`${Number(s.client_latitude).toFixed(4)}, ${Number(s.client_longitude).toFixed(4)}`:"-"})]},s.id))})]})}),(n==null?void 0:n.pagination)&&n.pagination.totalPages>1&&e.jsxs("div",{className:"flex items-center justify-between mt-4",children:[e.jsxs(y,{variant:"outline",size:"sm",disabled:g===1,onClick:()=>Q(s=>Math.max(1,s-1)),children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"Назад"]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Сторінка ",g," з ",n.pagination.totalPages,"(всього: ",n.pagination.total,")"]}),e.jsxs(y,{variant:"outline",size:"sm",disabled:g>=n.pagination.totalPages,onClick:()=>Q(s=>s+1),children:["Вперед",e.jsx(ue,{className:"w-4 h-4 ml-1"})]})]})]})})]})})]})]})}export{Ie as SocialProof};
