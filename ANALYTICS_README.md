# Система аналитики FetrInUA

Комплексная система отслеживания посетителей, событий и конверсий для интернет-магазина FetrInUA.

## Возможности

### 1. Отслеживание в реальном времени
- **Онлайн пользователи**: Видно, сколько пользователей сейчас на сайте
- **Текущая страница**: На какой странице находится каждый пользователь
- **Корзина**: Сколько товаров в корзине у каждого пользователя
- **Устройства**: Тип устройства (desktop/mobile/tablet)
- **Источник**: Откуда пришел пользователь (UTM метки, referrer)

### 2. Общая статистика
- Количество сессий и уникальных пользователей
- Просмотры страниц
- Среднее время на сайте
- Топ страниц
- Источники трафика
- Распределение по устройствам

### 3. Воронка продаж
Отслеживание всех этапов оформления заказа:
1. Зашел на сайт
2. Просмотрел товар
3. Добавил в корзину
4. Начал оформление заказа
5. Заполнил имя
6. Заполнил телефон
7. Выбрал доставку
8. Заполнил данные доставки
9. Выбрал оплату
10. Нажал "Оформить заказ"
11. Завершил заказ
12. Оплатил заказ

Для каждого этапа показывается:
- Количество пользователей
- Конверсия от предыдущего этапа
- Конверсия от начала воронки

### 4. Интеграции
- **Google Tag Manager**: Централизованное управление тегами
- **Google Analytics 4**: Расширенная аналитика и отчеты
- **Google Ads**: Отслеживание конверсий для рекламы
- **Facebook Pixel**: Отслеживание для Facebook/Instagram рекламы

## Структура базы данных

### Таблица `analytics_sessions`
Хранит информацию о сессиях пользователей:
- ID сессии (уникальный)
- ID пользователя (если авторизован)
- Fingerprint браузера
- UTM метки (source, medium, campaign, term, content)
- Referrer и landing page
- Технические данные (устройство, браузер, ОС, разрешение экрана)
- IP адрес, страна, город
- Статистика (просмотры страниц, время на сайте, товары в корзине)
- Статус онлайн/офлайн

### Таблица `analytics_page_views`
Хранит просмотры страниц:
- ID сессии
- URL и заголовок страницы
- Тип страницы (home, product, checkout и т.д.)
- ID товара (для страниц товаров)
- Время входа и выхода
- Время на странице
- Глубина прокрутки
- Количество кликов

### Таблица `analytics_events`
Хранит события пользователей:
- ID сессии и пользователя
- Тип события (add_to_cart, checkout_start и т.д.)
- Категория и метка события
- Данные события (JSON)
- ID товара и заказа
- Значение события

### Таблица `analytics_funnel`
Хранит прохождение воронки продаж:
- ID сессии, пользователя, заказа
- Временные метки для каждого этапа
- Товары в корзине и сумма
- Этап и причина отказа (если не завершил)

### Таблица `analytics_settings`
Хранит настройки интеграций:
- Google Tag Manager ID
- Google Analytics 4 ID
- Google Ads ID
- Facebook Pixel ID
- Прочие настройки

## API Endpoints

### Публичные (для отслеживания)

#### `POST /api/analytics/session`
Создать или обновить сессию
```json
{
  "sessionId": "uuid",
  "fingerprint": "hash",
  "userId": 123,
  "utmSource": "google",
  "utmMedium": "cpc",
  "utmCampaign": "spring_sale",
  "referrer": "https://google.com",
  "landingPage": "https://fetr.in.ua/",
  "deviceType": "mobile",
  "browser": "Chrome",
  "os": "Android",
  "screenResolution": "1920x1080",
  "language": "uk",
  "cartItemsCount": 2
}
```

#### `POST /api/analytics/page-view`
Записать просмотр страницы
```json
{
  "sessionId": "uuid",
  "pageUrl": "/product/123",
  "pageTitle": "Набір для валяння",
  "pageType": "product",
  "productId": 123
}
```

#### `PATCH /api/analytics/page-view/:id`
Обновить время на странице
```json
{
  "timeSpent": 45,
  "scrollDepth": 80,
  "clicksCount": 5
}
```

#### `POST /api/analytics/event`
Записать событие
```json
{
  "sessionId": "uuid",
  "userId": 123,
  "eventType": "add_to_cart",
  "eventCategory": "ecommerce",
  "eventLabel": "Набір для валяння",
  "eventData": { "options": ["red", "large"] },
  "productId": 123,
  "eventValue": 850
}
```

#### `POST /api/analytics/funnel`
Обновить воронку продаж
```json
{
  "sessionId": "uuid",
  "userId": 123,
  "orderId": "305335",
  "stage": "started_checkout",
  "cartProducts": [...],
  "cartTotal": 1500
}
```

#### `POST /api/analytics/session/:sessionId/offline`
Пометить сессию как офлайн

### Защищенные (только для админов)

#### `GET /api/analytics/realtime`
Получить онлайн пользователей

#### `GET /api/analytics/stats?from=YYYY-MM-DD&to=YYYY-MM-DD`
Получить общую статистику за период

#### `GET /api/analytics/funnel-stats?from=YYYY-MM-DD&to=YYYY-MM-DD`
Получить статистику воронки за период

#### `GET /api/analytics/settings`
Получить настройки аналитики

#### `PUT /api/analytics/settings`
Обновить настройки аналитики
```json
{
  "google_tag_manager_id": "GTM-XXXXXXX",
  "google_analytics_id": "G-XXXXXXXXXX",
  "google_ads_id": "AW-XXXXXXXXXX",
  "facebook_pixel_id": "XXXXXXXXXXXXXXX"
}
```

## Использование на фронтенде

### Автоматическое отслеживание

Система автоматически отслеживает:
- Просмотры страниц при навигации
- Время на странице
- Глубину прокрутки
- Клики
- Активность пользователя

### Ручное отслеживание событий

```typescript
import { trackEvent, trackFunnel } from '@/lib/analytics';

// Отследить событие
trackEvent({
  eventType: 'button_click',
  eventCategory: 'engagement',
  eventLabel: 'Subscribe to newsletter',
  eventData: { location: 'footer' },
});

// Отследить этап воронки
trackFunnel({
  stage: 'added_to_cart',
  cartProducts: items,
  cartTotal: 1500,
});
```

### Типы событий

- `page_view` - Просмотр страницы
- `product_view` - Просмотр товара
- `add_to_cart` - Добавление в корзину
- `remove_from_cart` - Удаление из корзины
- `update_cart` - Обновление корзины
- `checkout_start` - Начало оформления
- `checkout_fill_name` - Заполнение имени
- `checkout_fill_phone` - Заполнение телефона
- `checkout_select_delivery` - Выбор доставки
- `checkout_fill_delivery` - Заполнение доставки
- `checkout_select_payment` - Выбор оплаты
- `checkout_submit` - Отправка заказа
- `order_completed` - Завершение заказа
- `order_paid` - Оплата заказа
- `button_click` - Клик по кнопке
- `form_submit` - Отправка формы
- `link_click` - Клик по ссылке
- `scroll` - Прокрутка
- `error` - Ошибка

### Этапы воронки

- `visited_site` - Зашел на сайт
- `viewed_product` - Просмотрел товар
- `added_to_cart` - Добавил в корзину
- `started_checkout` - Начал оформление
- `filled_name` - Заполнил имя
- `filled_phone` - Заполнил телефон
- `selected_delivery` - Выбрал доставку
- `filled_delivery` - Заполнил доставку
- `selected_payment` - Выбрал оплату
- `clicked_submit` - Нажал "Оформить"
- `completed_order` - Завершил заказ
- `paid_order` - Оплатил заказ

## Настройка интеграций

### Google Tag Manager

1. Создайте аккаунт на [tagmanager.google.com](https://tagmanager.google.com)
2. Создайте контейнер для вашего сайта
3. Скопируйте ID контейнера (формат: GTM-XXXXXXX)
4. Вставьте в админпанели: Аналітика → Налаштування → Google Tag Manager ID
5. Сохраните настройки

### Google Analytics 4

1. Создайте аккаунт на [analytics.google.com](https://analytics.google.com)
2. Создайте ресурс GA4
3. Скопируйте идентификатор измерения (формат: G-XXXXXXXXXX)
4. Вставьте в админпанели: Аналітика → Налаштування → Google Analytics 4 ID
5. Сохраните настройки

### Google Ads

1. Войдите в [ads.google.com](https://ads.google.com)
2. Перейдите в "Інструменти" → "Відстеження конверсій"
3. Создайте действие конверсии
4. Скопируйте идентификатор конверсии (формат: AW-XXXXXXXXXX)
5. Вставьте в админпанели: Аналітика → Налаштування → Google Ads ID
6. Сохраните настройки

### Facebook Pixel

1. Создайте пиксель в [business.facebook.com](https://business.facebook.com)
2. Скопируйте ID пикселя
3. Вставьте в админпанели: Аналітика → Налаштування → Facebook Pixel ID
4. Сохраните настройки

## Дополнительные метрики для сбора

### Поведенческие метрики
- Время до первого взаимодействия
- Количество взаимодействий за сессию
- Паттерны навигации (последовательность страниц)
- Возвраты на предыдущие страницы
- Использование поиска на сайте
- Клики по категориям товаров

### Метрики товаров
- Самые просматриваемые товары
- Товары с наибольшей конверсией в корзину
- Товары с наибольшим отказом
- Средняя цена просматриваемых товаров
- Популярные комбинации опций

### Метрики корзины
- Средний размер корзины
- Среднее количество товаров
- Частота изменения корзины
- Время от добавления до оформления
- Брошенные корзины (не завершенные заказы)

### Метрики оформления
- Время заполнения каждого поля
- Количество ошибок валидации
- Использование автозаполнения
- Выбор способов доставки (распределение)
- Выбор способов оплаты (распределение)

### Технические метрики
- Скорость загрузки страниц
- Ошибки JavaScript
- Ошибки API запросов
- Размер экрана и viewport
- Скорость интернет-соединения

### Маркетинговые метрики
- ROI по источникам трафика
- Стоимость привлечения клиента (CAC)
- Lifetime Value (LTV)
- Повторные покупки
- Эффективность промокодов

## Рекомендации по использованию

1. **Регулярно проверяйте воронку продаж**: Находите узкие места, где пользователи отваливаются
2. **Анализируйте источники трафика**: Инвестируйте в каналы с лучшей конверсией
3. **Оптимизируйте под устройства**: Если много трафика с мобильных, улучшайте мобильную версию
4. **A/B тестирование**: Используйте данные для проверки гипотез
5. **Сегментация**: Анализируйте поведение разных групп пользователей
6. **Ретаргетинг**: Используйте данные о брошенных корзинах для ретаргетинга
7. **Персонализация**: Показывайте релевантные товары на основе истории просмотров

## Производительность

Система оптимизирована для минимального влияния на производительность сайта:
- Асинхронная отправка событий
- Батчинг запросов (heartbeat каждые 30 секунд)
- Локальное хранение session ID
- Автоматическая очистка старых данных
- Индексы в БД для быстрых запросов

## Приватность

- IP адреса не используются для идентификации пользователей
- Fingerprint используется только для технических целей
- Данные авторизованных пользователей связываются с их аккаунтами
- Соответствие GDPR (при необходимости добавить cookie consent)

## Развертывание

1. Примените SQL схему:
```bash
mysql -h HOST -u USER -p DATABASE < database/analytics_schema.sql
```

2. Перезапустите сервер для загрузки новых роутов

3. Откройте админпанель: https://fetr.in.ua/admin/analytics

4. Настройте интеграции в разделе "Налаштування"

5. Начните отслеживание!

## Поддержка

При возникновении проблем проверьте:
- Логи сервера (`server/api.log`)
- Консоль браузера (F12)
- Настройки аналитики в админпанели
- Подключение к базе данных

## Лицензия

Proprietary - FetrInUA © 2026

